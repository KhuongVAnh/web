// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int     @id @default(autoincrement())
  email     String  @unique
  username  String  @unique
  password  String
  role      String  @default("user") // "user" or "admin"
  fullName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([username])
}

model StudyRoom {
  id        Int     @id @default(autoincrement())
  roomNumber Int    @unique // 1-5
  name      String
  desks     Desk[]
  dhtReadings DHT[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([roomNumber])
}

model Desk {
  id              Int     @id @default(autoincrement())
  roomId          Int
  room            StudyRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  row             Int     // 1-4 (4 rows per room)
  position        Int     // 1-5 (5 tables per row)
  seats           Int     @default(2) // 2 seats per table
  
  // Device configuration
  lampPowerW      Float   @default(10.0) // Wattage of desk lamp
  lightStatus     Boolean @default(false) // Current light state
  
  // Sensor data
  occupancyStatus Boolean @default(false) // Is desk occupied
  occupancyStartTime DateTime? // When current occupancy started
  totalUsageMinutes Int @default(0) // Total accumulated usage
  disabled        Boolean @default(false) // Nếu true: bàn bị vô hiệu, cảm biến bị tắt

  // Energy tracking
  energyConsumedWh Float @default(0.0) // Energy consumed in Wh
  
  // Sensor configuration
  distanceSensitivity Float @default(30.0) // Distance threshold in cm for occupancy
  lastSensorReading Float? // Last distance reading
  sensorReadingTime DateTime?
  
  // ESP32 device ID (ESP32 can be moved to any desk)
  esp32DeviceId   String? @unique
  
  sensorReadings  SensorReading[]
  energyRecords   EnergyRecord[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([roomId, row, position])
  @@index([roomId])
  @@index([occupancyStatus])
}

model SensorReading {
  id          Int     @id @default(autoincrement())
  deskId      Int
  desk        Desk    @relation(fields: [deskId], references: [id], onDelete: Cascade)
  distanceCm  Float   // Distance reading from HC-SR04
  occupied    Boolean
  // Location at time of measurement (from ESP32 meta data)
  room        Int?    // Room number at time of measurement
  row         Int?    // Row number at time of measurement
  table       Int?    // Table number at time of measurement
  createdAt   DateTime @default(now())

  @@index([deskId, createdAt])
  @@index([room, row, table, createdAt])
}

model DHT {
  id          Int     @id @default(autoincrement())
  roomId      Int
  room        StudyRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  temperature Float
  humidity    Float
  createdAt   DateTime @default(now())

  @@index([roomId, createdAt])
}

model EnergyRecord {
  id              Int     @id @default(autoincrement())
  deskId          Int
  desk            Desk    @relation(fields: [deskId], references: [id], onDelete: Cascade)
  powerW          Float   // Power in watts
  durationMinutes Int     // Duration of usage
  energyWh        Float   // Energy in watt-hours
  // Location at time of energy session (from ESP32 meta data)
  room            Int?    // Room number at time of session
  row             Int?    // Row number at time of session
  table           Int?    // Table number at time of session
  createdAt       DateTime @default(now())

  @@index([deskId, createdAt])
  @@index([room, row, table, createdAt])
}

model ESP32Config {
  id        Int     @id @default(autoincrement())
  deviceId  String  @unique
  
  // Sampling frequencies
  fs1       Int     @default(3)       // HC-SR04 sampling frequency
  fs2       Int     @default(2)       // BH1750 sampling frequency
  fs3       Int     @default(1)       // DHT sampling frequency
  
  // Distance threshold
  distanceCm Float    @default(30.0)
  
  // Data transmission duration
  duration  Int       @default(4000)    // in milliseconds
  
  // Current location (can be updated via MQTT)
  room      Int?      // Current room number
  row       Int?       // Current row number
  table     Int?       // Current table number
  
  lastSync  DateTime?
  
  @@index([deviceId])
  @@index([room, row, table])
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

